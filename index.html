<!DOCTYPE html>
<html lang="lt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Duomenų Analitikos Sprendimai</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="bg-gray-50 text-gray-900 transition-colors">
  <div class="max-w-6xl mx-auto p-6">
    <header class="flex items-center justify-between mb-6">
      <h1 class="text-2xl font-bold">Duomenų Analitikos Sprendimai</h1>
      <div class="flex gap-2">
        <button id="ltBtn" class="px-3 py-1 rounded bg-gray-200">LT</button>
        <button id="enBtn" class="px-3 py-1 rounded bg-gray-200">EN</button>
        <button id="themeBtn" class="px-3 py-1 rounded bg-gray-800 text-white">Tema</button>
      </div>
    </header>

    <section class="mb-4">
      <h2 class="text-xl font-semibold" data-i18n="title">Skaitmeninės Gamybos Optimizavimas</h2>
      <p class="text-gray-600" data-i18n="subtitle">
        Įkelkite CSV failą, apskaičiuosime OEE, našumą, broką, „bottleneck“ ir potencialią mėnesio naudą.
      </p>
    </section>

    <!-- CSV įkėlimo forma -->
    <section class="mb-6 grid sm:grid-cols-2 gap-4">
      <div class="p-4 rounded-xl border bg-white">
        <label class="block text-sm mb-2" data-i18n="csv">CSV failas</label>
        <input id="file" type="file" accept=".csv" class="w-full" />
      </div>
      <div class="p-4 rounded-xl border bg-white grid grid-cols-3 gap-3 items-end">
        <div>
          <label class="block text-sm" data-i18n="unit_cost">Vieneto savikaina (€)</label>
          <input id="unitCost" type="number" step="0.01" value="5" class="w-full border rounded p-2" />
        </div>
        <div>
          <label class="block text-sm" data-i18n="workdays">Darbo d. / mėn.</label>
          <input id="workdays" type="number" value="21" class="w-full border rounded p-2" />
        </div>
        <div>
          <label class="block text-sm" data-i18n="shift">Pamainos val.</label>
          <input id="shift" type="number" step="0.5" value="8" class="w-full border rounded p-2" />
        </div>
        <div class="col-span-3">
          <label class="block text-sm" data-i18n="target_oee">Tikslinis OEE</label>
          <input id="targetOee" type="number" step="0.01" value="0.85" class="w-full border rounded p-2" />
        </div>
      </div>
    </section>

    <section class="mb-6">
      <button id="analyzeBtn" class="px-4 py-2 rounded-xl bg-blue-600 text-white font-semibold">
        <span data-i18n="analyze">Analizuoti</span>
      </button>
      <span id="status" class="ml-3 text-sm text-gray-600"></span>
    </section>

    <!-- KPI rodikliai -->
    <section id="kpis" class="grid sm:grid-cols-3 gap-4 mb-6 hidden">
      <div class="p-4 rounded-xl border bg-white">
        <div class="text-sm text-gray-500">OEE</div>
        <div id="oee" class="text-2xl font-bold">–</div>
      </div>
      <div class="p-4 rounded-xl border bg-white">
        <div class="text-sm text-gray-500" data-i18n="throughput">Našumas / val.</div>
        <div id="throughput" class="text-2xl font-bold">–</div>
      </div>
      <div class="p-4 rounded-xl border bg-white">
        <div class="text-sm text-gray-500" data-i18n="savings">Sutaupymai / mėn.</div>
        <div id="savings" class="text-2xl font-bold">–</div>
      </div>
    </section>

    <!-- Grafikai ir prastovos -->
    <section class="grid sm:grid-cols-2 gap-6">
      <div class="p-4 rounded-xl border bg-white">
        <h3 class="font-semibold mb-2" data-i18n="downtime">Top prastovos</h3>
        <ul id="downtimeList" class="list-disc pl-5 text-sm text-gray-700"></ul>
      </div>
      <div class="p-4 rounded-xl border bg-white">
        <h3 class="font-semibold mb-2" data-i18n="charts">Rodikliai</h3>
        <canvas id="chart"></canvas>
      </div>
    </section>
  </div>

  <script>
    const BACKEND_URL = "http://localhost:8000/analyze"; // jei backend paleistas lokaliai

    let chart;
    async function analyze() {
      const file = document.getElementById('file').files[0];
      if (!file) { alert('Pasirink CSV failą'); return; }

      const fd = new FormData();
      fd.append('file', file);
      fd.append('unit_cost_eur', document.getElementById('unitCost').value);
      fd.append('workdays_per_month', document.getElementById('workdays').value);
      fd.append('shift_hours', document.getElementById('shift').value);
      fd.append('target_oee', document.getElementById('targetOee').value);

      const status = document.getElementById('status');
      status.textContent = 'Skaičiuojama...';

      try {
        const res = await fetch(BACKEND_URL, { method: 'POST', body: fd });
        const data = await res.json();

        document.getElementById('kpis').classList.remove('hidden');
        document.getElementById('oee').textContent = (data.oee * 100).toFixed(1) + '%';
        document.getElementById('throughput').textContent = data.throughput_per_hour.toFixed(0);
        document.getElementById('savings').textContent = '€' + data.potential_savings_eur_per_month.toFixed(2);

        const ul = document.getElementById('downtimeList');
        ul.innerHTML = '';
        (data.top_downtime || []).forEach(d => {
          const li = document.createElement('li');
          li.textContent = `${d.reason}: ${d.minutes} min`;
          ul.appendChild(li);
        });

        const ctx = document.getElementById('chart');
        if (chart) chart.destroy();
        chart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: ['OEE', 'Availability', 'Performance', 'Quality', 'Scrap'],
            datasets: [{ label: 'Vertės', data: [data.oee, data.availability, data.performance, data.quality, data.scrap_rate], backgroundColor: 'rgba(37,99,235,0.5)' }]
          },
          options: { responsive: true, scales: { y: { min: 0, max: 1 } } }
        });

        status.textContent = '✅ Atlikta';
      } catch (err) {
        console.error(err);
        status.textContent = '❌ Klaida (API nepasiekiamas ar CSV neteisingas).';
      }
    }

    document.getElementById('analyzeBtn').onclick = analyze;
  </script>
</body>
</html>
